#!/usr/bin/env bash

# Exit immediately if a command exits with a non-zero status.
set -e

# Define the directory where backups will be stored
backup_dir="$HOME/.config/.backups"

# Create the backup directory if it doesn't exist
mkdir -p "$backup_dir"

echo "Starting dotfiles backup process..."
echo "Backup directory: $backup_dir"

# Loop through each subdirectory in .dotfiles/, treating each as a stow package
# For example: .dotfiles/bash, .dotfiles/nvim
for package_source_dir in .dotfiles/*; do
    # Ensure it's a directory
    if [ -d "$package_source_dir" ]; then
        package_name=$(basename "$package_source_dir")
        echo "Processing package: $package_name"

        # --- Handle items that would be linked directly to $HOME ---
        # These are files/directories starting with '.' directly inside the package,
        # e.g., arch-dotfiles/.dotfiles/bash/.bashrc -> $HOME/.bashrc
        for entry in "$package_source_dir"/.*; do
            # Skip '.' and '..' entries
            if [[ "$(basename "$entry")" == "." || "$(basename "$entry")" == ".." ]]; then
                continue
            fi

            # Check if the entry exists as a regular file or directory within the package
            if [ -e "$entry" ]; then
                # Determine the expected target path in $HOME
                target_basename=$(basename "$entry") # e.g., .bashrc, .profile
                target_path="$HOME/$target_basename"
                backup_filename="${target_basename}.bak"
                full_backup_path="$backup_dir/$backup_filename"

                # Check if the target exists in HOME and is not a symbolic link (stow-managed)
                if [ -e "$target_path" ] && [ ! -L "$target_path" ]; then
                    echo "  Backing up existing $target_path to $full_backup_path"
                    mv "$target_path" "$full_backup_path"
                else
                    echo "  $target_path does not exist or is a symlink, skipping."
                fi
            fi
        done

        # --- Handle items that would be linked to $HOME/.config/ ---
        # These are files/directories directly inside a '.config' subdirectory within the package,
        # e.g., arch-dotfiles/.dotfiles/nvim/.config/nvim -> $HOME/.config/nvim
        # e.g., arch-dotfiles/.dotfiles/ghostty/.config/config -> $HOME/.config/config
        config_source_dir="$package_source_dir/.config"
        if [ -d "$config_source_dir" ]; then
            for entry in "$config_source_dir"/* "$config_source_dir"/.*; do
                # Skip '.' and '..' entries
                if [[ "$(basename "$entry")" == "." || "$(basename "$entry")" == ".." ]]; then
                    continue
                fi

                # Check if the entry exists as a regular file or directory within .config
                if [ -e "$entry" ]; then
                    # Determine the expected target path in $HOME/.config/
                    target_basename=$(basename "$entry") # e.g., nvim, kitty, config
                    target_path="$HOME/.config/$target_basename"
                    backup_filename="${target_basename}.bak"
                    full_backup_path="$backup_dir/$backup_filename"

                    # Check if the target exists in HOME/.config and is not a symbolic link
                    if [ -e "$target_path" ] && [ ! -L "$target_path" ]; then
                        echo "  Backing up existing $target_path to $full_backup_path"
                        mv "$target_path" "$full_backup_path"
                    else
                        echo "  $target_path does not exist or is a symlink, skipping."
                    fi
                fi
            done
        fi
    fi
done

echo "Dotfiles backup process completed."
