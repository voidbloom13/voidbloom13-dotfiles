#!/usr/bin/env bash

FACE="$HOME/voidbloom13-dotfiles/assets/profile.jpg"
WALLPAPER="$HOME/voidbloom13-dotfiles/assets/ubuntu-wallpaper.jpg"
LOGIN_WALLPAPER="$HOME/voidbloom13-dotfiles/assets/ubuntu-gdm-wallpaper.jpg"
TERM_WALLPAPER="$HOME/voidbloom13-dotfiles/assets/terminal-wallpaper.jpg"

function main {
    # System Update + Nala
    sudo apt update && sudo apt upgrade -y
    sudo apt install -y nala

    # Base Packages
    sudo nala install -y \
        bat \
        curl \
        flatpak \
        fzf \
        git \
        man-db \
        neofetch \
        ripgrep \
        rsync \
        stow \
        tmux \
        tree \
        unzip \
        zip \
        zoxide \
        zsh

    # Neovim PPA (0.11+ for LazyVim)
    sudo add-apt-repository -y ppa:neovim-ppa/unstable
    sudo nala update
    sudo nala install -y neovim

    # GitHub CLI
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    sudo nala update
    sudo nala install -y gh

    # Tailscale
    curl -fsSL https://tailscale.com/install.sh | sh

    # Docker
    sudo apt remove $(dpkg --get-selections docker.io docker-compose docker-compose-v2 docker-doc podman-docker containerd runc | cut -f1)
    sudo apt update
    sudo nala install -y ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc
    sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF
    sudo nala update
    sudo nala install -y \
        docker-ce \
        docker-ce-cli \
        containerd.io \
        docker-buildx-plugin \
        docker-compose-plugin

    # Languages
    # Microsoft .NET repo
    sudo nala install -y software-properties-common
    curl -fsSL https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb -o /tmp/packages-microsoft-prod.deb
    sudo dpkg -i /tmp/packages-microsoft-prod.deb
    rm /tmp/packages-microsoft-prod.deb
    sudo nala update
    sudo nala install -y \
        build-essential \
        default-jdk \
        dotnet-sdk-10.0 \
        maven \
        postgresql \
        postgresql-contrib \
        nodejs \
        npm \
        python3 \
        python3-pip \
        python3-venv

    # Claude Code
    curl -fsSL https://claude.ai/install.sh | bash

    # NVM and NodeJS LTS
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.4/install.sh | bash
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
    . $HOME/.bashrc && . $HOME/.profile
    nvm install --lts && nvm use --lts

    # SDKMAN and Spring CLI
    curl -s "https://get.sdkman.io" | bash
    source "$HOME/.sdkman/bin/sdkman-init.sh"
    sdk install springboot

    # TMUX Theme and TPM
    mkdir -p ~/.config/tmux/plugins/catppuccin
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    git clone -b v2.1.3 https://github.com/catppuccin/tmux.git ~/.config/tmux/plugins/catppuccin/tmux

    # NPM Packages
    sudo npm install -g \
        @angular/cli \
        @angular/language-server \
        @google/gemini-cli \
        nodemon \
        prettier-plugin-tailwindcss \
        typescript \
        typescript-language-server \
        @tailwindcss/language-server

    # PostgreSQL Init
    sudo pg_ctlcluster $(pg_lsclusters -h | head -1 | awk '{print $1}') main start

    # Dotfiles Sync
    find "$HOME/voidbloom13-dotfiles/.dotfiles/" -mindepth 1 -maxdepth 1 -type d | while read -r package; do
        bash $HOME/voidbloom13-dotfiles/scripts/stow $(basename "$package")
    done
    ln -s $HOME/voidbloom13-dotfiles/.prettierrc.json $HOME/.prettierrc.json

    # GUI Apps
    if ! uname -a | grep -q WSL && (pgrep -l "Xorg" || pgrep -l "wayland"); then
        # Google Chrome
        curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/google-chrome-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list > /dev/null
        sudo nala update
        sudo nala install -y \
            google-chrome-stable \
            kitty

        git clone --depth=1 https://github.com/ryanoasis/nerd-fonts $HOME/Downloads/nerd-fonts
        cd $HOME/Downloads/nerd-fonts/
        ./install.sh

        ln -s $TERM_WALLPAPER ~/.config/kitty/wallpaper.jpg
        git clone https://github.com/supermariofps/hatsune-miku-windows-linux-cursors $HOME/Downloads/hm-cursors
        sudo cp -r $HOME/Downloads/hm-cursors/miku-cursor-linux /usr/share/icons/miku-cursor-linux

        git clone https://github.com/vinceliuice/tela-circle-icon-theme $HOME/Downloads/circle-icons
        sudo $HOME/Downloads/circle-icons/install.sh -c dracula -d /usr/share/icons/ -n "circle-icons"
    fi

    # DE-Specific Setup
    case "$XDG_CURRENT_DESKTOP" in
        *GNOME*)
            echo "Setting up Gnome Desktop..."
            sudo nala install -y \
                gnome-tweaks \
                gnome-shell-extensions
            flatpak install GdmSettings

            cp $HOME/voidbloom13-dotfiles/assets/profile.jpg $HOME/.face
            sudo busctl call org.freedesktop.Accounts /org/freedesktop/Accounts/User$(id -u) org.freedesktop.Accounts.User SetIconFile s "$HOME/.face"
            gsettings set org.gnome.desktop.background picture-uri "file://$WALLPAPER"
            gsettings set org.gnome.desktop.background picture-uri-dark "file://$WALLPAPER"
            gsettings set org.gnome.desktop.interface cursor-theme "miku-cursor-linux"
            gsettings set org.gnome.desktop.interface icon-theme "circle-icons-dracula-dark"
            ;;
        *KDE*)
            echo "Setting up KDE Plasma Desktop..."
            sudo nala install -y \
                sddm \
                sddm-kcm \
                libqt6svg6 \
                libqt6virtualkeyboard6 \
                libqt6multimedia6 \
                qml6-module-qtquick-virtualkeyboard \
                qml6-module-qtmultimedia
            #             git clone -b main --depth=1 https://github.com/uiriansan/SilentSDDM
            #             cd SilentSDDM
            #             sudo mkdir -p /usr/share/sddm/themes/silent
            #             sudo cp -rf . /usr/share/sddm/themes/silent
            #             sudo cp -r /usr/share/sddm/themes/silent/fonts/* /usr/share/fonts/
            #             sudo tee /etc/sddm.conf.d/theme.conf > /dev/null <<EOF
            # [General]
            # GreeterEnvironment=QML2_IMPORT_PATH=/usr/share/sddm/themes/silent/components/,QT_IM_MODULE=qtvirtualkeyboard
            #
            # [Theme]
            # Current=silent
            # EOF

            cp $HOME/voidbloom13-dotfiles/assets/profile.jpg $HOME/.face.icon
            sudo cp $HOME/.face.icon /usr/share/sddm/faces/$(whoami).face.icon
            plasma-apply-wallpaperimage "$WALLPAPER"
            plasma-apply-cursortheme "miku-cursor-linux"
            $(locate plasma-changeicons) "circle-icons-dracula-dark"
            echo -e "\e[1;97mUncomment Theme section from voidbloom13-dotfiles/scripts/apt_install if using KDE Plasma 6+ (Kubuntu 25.10)"
            ;;
        *)
            echo "$XDG_CURRENT_DESKTOP not supported. Please ensure settings are configured manually."
            ;;
    esac

    # Git and Github Setup
    echo -e "\e[1;44;87m             Git and Github Setup             \e[0m"
    read -p "Setup git/github? [Y/n] " setup_git
    setup_git=${setup_git:-Y}
    case $setup_git in
        [yY] )
            read -p "Git config name: " git_name
            read -p "Git config email: " git_email
            git config --global user.name "$git_name" && git config --global user.email "$git_email"
            gh auth login
            ;;
        [nN] )
            echo "Exiting git setup..."
            ;;
        * )
            echo "Exiting git setup..."
            ;;
    esac

    # Systemd Services
    sudo systemctl enable --now docker
    sudo usermod -aG docker $USER
    sudo systemctl enable --now postgresql
    sudo systemctl enable --now tailscaled

    # Post-Install
    . ~/.profile && . ~/.bashrc
    clear && neofetch
    echo -e "\e[1;37mNext Steps\e[0m:"
    echo -e "* Run \e[1;33m[sudo tailscale up]\e[0m and follow the link to set up \e[1;33mTailscale VPN\e[0m"
    echo -e "* Run \e[1;35m[chsh]\e[0m and change user shell to \e[1;35m/usr/bin/zsh\e[0m"
    echo -e "* Run \e[1;32m[tmux]\e[0m and press \e[1;32m[<ctrl>+b, i]\e[0m to install tmux plugins"
}

main
